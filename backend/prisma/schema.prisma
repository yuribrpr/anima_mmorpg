generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum PowerLevel {
  ROOKIE
  CHAMPION
  ULTIMATE
  MEGA
  BURST_MODE
}

enum UserRole {
  PLAYER
  ADMIN
}

enum ItemType {
  CONSUMIVEL
  QUEST
  NORMAL
}

enum PlayerQuestStatus {
  ACTIVE
  COMPLETED
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  username      String         @unique
  passwordHash  String
  role          UserRole       @default(PLAYER)
  adoptedAnimas AdoptedAnima[]
  mapStates     PlayerMapState[]
  inventory     UserInventory?
  quests        PlayerQuest[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model GameMap {
  id                  String           @id @default(cuid())
  name                String
  worldWidth          Int              @default(1920)
  worldHeight         Int              @default(1088)
  cellSize            Int              @default(32)
  cols                Int              @default(60)
  rows                Int              @default(34)
  backgroundImageData String?          @db.LongText
  backgroundScale     Float            @default(1)
  tilePalette         Json
  tileLayer           Json
  collisionLayer      Json
  enemySpawns         Json?
  portals             Json?
  npcPlacements       Json?
  spawnX              Int              @default(0)
  spawnY              Int              @default(0)
  isActive            Boolean          @default(false)
  playerStates        PlayerMapState[]
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt

  @@index([isActive])
}

model NpcDefinition {
  id        String      @id @default(cuid())
  name      String
  imageData String?     @db.LongText
  dialogs   Json
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  quests    PlayerQuest[]

  @@index([name])
}

model PlayerQuest {
  id            String            @id @default(cuid())
  userId        String
  questKey      String
  sourceNpcId   String
  sourceNpcName String
  title         String
  description   String
  data          Json
  progress      Json
  status        PlayerQuestStatus @default(ACTIVE)
  completedAt   DateTime?
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceNpc     NpcDefinition     @relation(fields: [sourceNpcId], references: [id], onDelete: Restrict)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([userId, questKey])
  @@index([userId, status])
  @@index([sourceNpcId])
}

model PlayerMapState {
  id        String   @id @default(cuid())
  userId    String
  mapId     String
  tileX     Int
  tileY     Int
  scaleX    Float    @default(3)
  scaleY    Float    @default(3)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  map       GameMap  @relation(fields: [mapId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, mapId])
  @@index([mapId])
}

model Anima {
  id                 String    @id @default(cuid())
  name               String
  attack             Int
  attackSpeedSeconds Float
  critChance         Float
  agility            Int
  defense            Int
  maxHp              Int
  imageData          String?   @db.LongText
  spriteScale        Float     @default(3)
  flipHorizontal     Boolean   @default(true)
  powerLevel         PowerLevel
  nextEvolutionId    String?
  nextEvolutionLevelRequired Int @default(10)
  nextEvolution      Anima?    @relation("AnimaEvolution", fields: [nextEvolutionId], references: [id], onDelete: SetNull)
  previousEvolutions Anima[]   @relation("AnimaEvolution")
  adoptedBy          AdoptedAnima[]
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([name])
  @@index([powerLevel])
}

model AdoptedAnima {
  id                   String    @id @default(cuid())
  userId               String
  baseAnimaId          String
  nickname             String
  level                Int       @default(1)
  experience           Int       @default(0)
  experienceMax        Int       @default(1000)
  currentHp            Int
  bonusAttack          Int       @default(0)
  bonusDefense         Int       @default(0)
  bonusMaxHp           Int       @default(0)
  attackSpeedReduction Float     @default(0)
  critChanceBonus      Float     @default(0)
  isPrimary            Boolean   @default(false)
  isNextEvolutionUnlocked Boolean @default(false)
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  baseAnima            Anima     @relation(fields: [baseAnimaId], references: [id], onDelete: Restrict)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([userId])
  @@index([baseAnimaId])
  @@index([userId, isPrimary])
}

model GlobalSettings {
  id            String   @id @default(cuid())
  singletonKey  String   @unique @default("global")
  expMultiplier Float    @default(1)
  bitsMultiplier Float   @default(1)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model BestiaryAnima {
  id                 String     @id @default(cuid())
  name               String
  attack             Int
  attackSpeedSeconds Float
  critChance         Float
  agility            Int
  defense            Int
  maxHp              Int
  imageData          String?    @db.LongText
  spriteScale        Float      @default(3)
  flipHorizontal     Boolean    @default(true)
  powerLevel         PowerLevel
  bitsDrop           Int
  xpDrop             Int
  drops              BestiaryDrop[]
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  @@index([name])
  @@index([powerLevel])
}

model UserInventory {
  id        String   @id @default(cuid())
  userId    String   @unique
  bits      Int      @default(3865)
  crystals  Int      @default(43)
  layout    Json
  hotbar    Json
  items     UserInventoryItem[]
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Item {
  id               String              @id @default(cuid())
  name             String
  description      String
  type             ItemType
  imageData        String?             @db.LongText
  stackSize        Int                 @default(99)
  healPercentMaxHp Float               @default(0)
  bonusAttack      Int                 @default(0)
  bonusDefense     Int                 @default(0)
  bonusMaxHp       Int                 @default(0)
  drops            BestiaryDrop[]
  inventoryItems   UserInventoryItem[]
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([name])
  @@index([type])
}

model BestiaryDrop {
  id             String       @id @default(cuid())
  bestiaryAnimaId String
  itemId         String
  quantity       Int          @default(1)
  dropChance     Float
  bestiaryAnima  BestiaryAnima @relation(fields: [bestiaryAnimaId], references: [id], onDelete: Cascade)
  item           Item         @relation(fields: [itemId], references: [id], onDelete: Restrict)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([bestiaryAnimaId])
  @@index([itemId])
}

model UserInventoryItem {
  id          String        @id @default(cuid())
  inventoryId String
  itemId      String
  quantity    Int           @default(1)
  slot        Int?
  inventory   UserInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  item        Item          @relation(fields: [itemId], references: [id], onDelete: Restrict)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([inventoryId, itemId])
  @@index([inventoryId, slot])
}
